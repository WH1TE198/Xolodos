from datetime import datetime, date
from products_db import list_products
from recipes_db import get_all_recipes

ALIASES = {
    "авокадо": "авокадо",
    "анчоусы": "анчоусы",
    "батон": "хлеб",
    "бекон": "бекон",
    "болгарский перец": "перец",
    "бульон": "куриный бульон",
    "горошек": "горошек",
    "греческий йогурт": "йогурт",
    "дрожжи": "дрожжи",
    "зеленый лук": "зелень",
    "зелёный лук": "зелень",
    "зелень": "зелень",
    "какао-порошок": "какао",
    "капуста": "капуста",
    "кефир 1%": "кефир",
    "кефир 2,5%": "кефир",
    "кефир": "кефир",
    "колбаса": "колбаса",
    "консервированный тунец": "тунец консервированный",
    "краб-палочки": "крабовые палочки",
    "крабовые палочки": "крабовые палочки",
    "лаваш тонкий": "лаваш",
    "лаваш": "лаваш",
    "лепешки": "тортильи",
    "листы лазаньи": "листы лазаньи",
    "лук репчатый": "лук",
    "макароны": "паста",
    "масло растительное": "масло",
    "масло сливочное": "масло",
    "мед": "мёд",
    "моцарелла": "сыр моцарелла",
    "нори лист": "нори",
    "нори": "нори",
    "овсяные хлопья": "овсянка",
    "огурцы": "огурец",
    "оливковое масло": "масло",
    "паприка": "паприка",
    "пельмешки": "пельмени",
    "пельмени": "пельмени",
    "перец болгарский": "перец",
    "помидор": "томаты",
    "помидоры": "томаты",
    "рис арборио": "рис",
    "рисовая лапша": "лапша",
    "растительное масло": "масло",
    "сметана 15%": "сметана",
    "сметана 20%": "сметана",
    "сметана": "сметана",
    "соус терияки": "соевый соус",
    "спагетти": "паста",
    "сливки": "сливки",
    "сыр пармезан": "сыр",
    "сыр моцарелла": "сыр моцарелла",
    "сыр фета": "сыр фета",
    "тахини": "тахини",
    "томат": "томаты",
    "томатная паста": "томаты",
    "томаты": "томаты",
    "тортилья": "тортильи",
    "тунец": "тунец консервированный",
    "тунец консервированный": "тунец консервированный",
    "хлеб тостовый": "хлеб",
    "хлеб": "хлеб",
    "хлопья овсяные": "овсянка",
    "терияки": "соевый соус",
    "яйца куриные": "яйца",
    "яйцо": "яйца",
    "ягоды": "ягоды",
    "йогурт натуральный": "йогурт",
    "йогурт": "йогурт",
}


def norm(s: str) -> str:
    k = (s or "").strip().lower()
    return ALIASES.get(k, k)

def _parse_date(s: str):
    try:
        return datetime.strptime((s or "").strip(), "%d.%m.%Y").date()
    except Exception:
        return None

def suggest_recipes(top_n: int = 10):
    """Возвращает [{recipe, score, coverage, have[], missing[]}, ...]."""
    try:
        prods = list_products(limit=2000)
    except Exception:
        prods = []
    have_map = {norm(p.get("name")): p for p in prods if (p.get("name") or "").strip()}
    today = date.today()

    out = []
    for r in get_all_recipes():
        ings = r.get("ingredients", [])
        if not ings:
            continue

        hits, missing, bonus = [], [], 0
        for i in ings:
            key = norm(i.get("name"))
            if key in have_map:
                hits.append(i)
                d = _parse_date(have_map[key].get("exp_date"))
                if d:
                    days = (d - today).days
                    bonus += max(0, 10 - days)
            else:
                missing.append(i)

        coverage = len(hits) / len(ings)
        score = int(coverage * 100 + bonus)
        out.append({"recipe": r, "coverage": coverage, "score": score, "have": hits, "missing": missing})

    out.sort(key=lambda x: (x["coverage"] >= 0.7, x["score"]), reverse=True)
    return out[:top_n]
